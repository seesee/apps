const CACHE_NAME="activity-tracker-v1",urlsToCache=["./","./index.html","./sw.js"];function broadcastMessage(e){return clients.matchAll({type:"window"}).then(t=>{t.forEach(t=>{t.postMessage(e)})})}function isAppOpen(){return clients.matchAll({type:"window"}).then(e=>e.some(e=>e.url.includes("activity-tracker")||e.url.includes("index.html")||e.url.includes("activity_tracker.html")))}function getAppUrl(){const e=self.location.href;e.substring(0,e.lastIndexOf("/")+1);return e.includes("/activity-tracker/")||e.includes("/dist/")?"./index.html":"./activity_tracker.html"}self.addEventListener("install",e=>{console.log("Service Worker installing..."),e.waitUntil(caches.open(CACHE_NAME).then(e=>(console.log("Opened cache"),Promise.allSettled(urlsToCache.map(t=>e.add(t).catch(e=>(console.warn(`Failed to cache ${t}:`,e.message),null)))).then(e=>{const t=e.filter(e=>"fulfilled"===e.status).length,i=e.filter(e=>"rejected"===e.status).length;console.log(`Cache results: ${t} successful, ${i} failed`)}))).catch(e=>{console.error("Cache installation failed:",e)})),self.skipWaiting()}),self.addEventListener("activate",e=>(console.log("Service Worker activated"),e.waitUntil(caches.keys().then(e=>Promise.all(e.map(e=>{if(e!==CACHE_NAME)return console.log("Deleting old cache:",e),caches.delete(e)})))),self.clients.claim())),self.addEventListener("fetch",e=>{e.request.url.startsWith("http")&&e.respondWith(caches.match(e.request).then(t=>t||fetch(e.request).catch(t=>{if(console.warn("Fetch failed for:",e.request.url,t.message),"navigate"===e.request.mode)return new Response("App offline",{status:200,statusText:"OK",headers:{"Content-Type":"text/html"}});throw t})).catch(t=>(console.warn("Cache match failed for:",e.request.url,t.message),fetch(e.request))))}),self.addEventListener("notificationclick",e=>{console.log("Notification clicked:",e.notification.tag),e.notification.close(),"activity-reminder"!==e.notification.tag&&"test-notification"!==e.notification.tag||e.waitUntil(clients.matchAll({type:"window"}).then(e=>{for(const t of e)if(t.url.includes("activity-tracker")||t.url.includes("index.html")||t.url.includes("activity_tracker.html"))return t.focus(),void t.postMessage({type:"navigate-to-tracker"});if(clients.openWindow)return clients.openWindow(getAppUrl()+"#tracker")}))}),self.addEventListener("notificationactionclick",e=>{if(console.log("Notification action clicked:",e.action),e.notification.close(),"reply"===e.action){const t=e.reply;if(console.log("User replied:",t),t&&t.trim()){const i={id:Date.now().toString()+Math.random().toString(36).substr(2,9),activity:t.trim(),description:"Added via notification",timestamp:(new Date).toISOString(),created:(new Date).toISOString()};e.waitUntil(clients.matchAll({type:"window"}).then(e=>{let t=!1;for(const n of e)(n.url.includes("activity-tracker")||n.url.includes("index.html")||n.url.includes("activity_tracker.html"))&&(n.postMessage({type:"add-entry",entry:i}),t=!0);if(!t)return clients.openWindow(getAppUrl()).then(e=>{setTimeout(()=>{e.postMessage({type:"add-entry",entry:i})},2e3)})}))}}}),self.addEventListener("push",e=>{console.log("Push message received");let t={};if(e.data)try{t=e.data.json()}catch(i){t={title:"Activity Tracker",body:e.data.text()}}const i={body:t.body||"New notification from Activity Tracker",icon:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23667eea"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>',badge:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23667eea"><circle cx="12" cy="12" r="10"/></svg>',tag:t.tag||"push-notification",requireInteraction:!0,actions:[{action:"reply",type:"text",title:"Log Activity",placeholder:"What are you working on?"},{action:"dismiss",title:"Dismiss"}],data:t};e.waitUntil(self.registration.showNotification(t.title||"Activity Tracker",i))}),self.addEventListener("sync",e=>{console.log("Background sync triggered:",e.tag),"sync-activities"===e.tag&&e.waitUntil(Promise.resolve().then(()=>{console.log("Activities synced")}))}),self.addEventListener("message",e=>{console.log("Message received in SW:",e.data),e.data&&"SKIP_WAITING"===e.data.type&&self.skipWaiting(),e.data&&"GET_VERSION"===e.data.type&&e.ports[0].postMessage({version:CACHE_NAME})}),self.addEventListener("error",e=>{console.error("Service Worker error:",e.error)}),self.addEventListener("unhandledrejection",e=>{console.error("Service Worker unhandled rejection:",e.reason)}),console.log("Service Worker loaded");